<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Board Game Collection</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px;
            background-color: #f4f4f4;
        }
        #image-selector {
            margin-bottom: 20px;
            padding: 10px;
            font-size: 16px;
        }
        #image-container {
            position: relative;
            border: 1px solid #ccc;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            background-color: white;
            max-width: 90%; /* Ensure image fits within viewport */
            height: auto;
        }
        #boardgame-image {
            display: block; /* Remove extra space below image */
            max-width: 100%;
            height: auto;
        }
        .bounding-box {
            position: absolute;
            border: 2px solid red;
            cursor: pointer;
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
            opacity: 0.7;
        }
        .bounding-box:hover {
            border-color: blue;
            opacity: 1;
        }
        .box-info {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 3px 5px;
            border-radius: 3px;
            font-size: 12px;
            white-space: nowrap;
            pointer-events: none;
            transform: translateY(-100%); /* Position above the box */
            left: 0;
            top: 0;
            display: none; /* Hidden by default */
        }
        #info-box {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
            pointer-events: none; /* Allow mouse events to pass through to the bounding box */
        }
    </style>
</head>
<body>
    <h1>Board Game Collection Viewer</h1>

    <select id="image-selector">
        <option value="">Select an image</option>
    </select>

    
    

    <div style="margin-bottom: 10px;">
        <input type="checkbox" id="alwaysDisplayInfo">
        <label for="alwaysDisplayInfo">Always display information</label>
    </div>

    <div id="image-container">
        <img id="boardgame-image" src="" alt="Board Game Collection">
        <div id="info-box"></div>
    </div>

    <script type="text/javascript">
        console.log("Script started."); // Added for debugging
        let boardgamesData = [];
        const imageSelector = document.getElementById('image-selector');
        const boardgameImage = document.getElementById('boardgame-image');
        const imageContainer = document.getElementById('image-container');
        const infoBox = document.getElementById('info-box');
        
        const alwaysDisplayInfoCheckbox = document.getElementById('alwaysDisplayInfo');

        // Fetch the JSON data
        fetch('boardgames2.json')
            .then(response => response.json())
            .then(data => {
                boardgamesData = data;
                console.log('Fetched boardgamesData:', boardgamesData); // Add this line
                populateImageSelector(data);
                restoreStateFromLocalStorage();
            })
            .catch(error => console.error('Error fetching boardgames data:', error));

        function populateImageSelector(data) {
            const uniqueFilenames = [...new Set(data.map(item => item.filename))];
            console.log('Unique filenames:', uniqueFilenames); // Add this line
            uniqueFilenames.forEach(filename => {
                const option = document.createElement('option');
                option.value = filename;
                option.textContent = filename;
                imageSelector.appendChild(option);
            });
        }

        imageSelector.addEventListener('change', (event) => {
            const selectedFilename = event.target.value;
            localStorage.setItem('selectedImage', selectedFilename);
            if (selectedFilename) {
                boardgameImage.src = selectedFilename;
                boardgameImage.onload = () => {
                    displayBoundingBoxes(selectedFilename);
                    updateDisplayMode(); // Add this line
                };
            } else {
                boardgameImage.src = '';
                clearBoundingBoxes();
            }
        });

        

        alwaysDisplayInfoCheckbox.addEventListener('change', () => {
            localStorage.setItem('alwaysDisplayInfo', alwaysDisplayInfoCheckbox.checked);
            updateDisplayMode();
        });

        function clearBoundingBoxes() {
            // Remove all existing bounding boxes
            const existingBoxes = imageContainer.querySelectorAll('.bounding-box');
            existingBoxes.forEach(box => box.remove());
        }

        function displayBoundingBoxes(filename) {
            clearBoundingBoxes();

            const displayWidth = boardgameImage.offsetWidth;
            const displayHeight = boardgameImage.offsetHeight;

            // Calculate the actual scaling factor of the displayed image relative to its natural size
            const actualImageScaleX = displayWidth / 1024; // Assuming original image width is 1024px
            const actualImageScaleY = displayHeight / 1024; // Assuming original image height is 1024px

            const boxesForImage = boardgamesData.filter(item => item.filename === filename);

            boxesForImage.forEach(item => {
                const [y1, x1, y2, x2] = item.box_2d;

                const boxDiv = document.createElement('div');
                boxDiv.classList.add('bounding-box');
                // Apply actual image display scale
                boxDiv.style.left = `${x1 * actualImageScaleX}px`;
                boxDiv.style.top = `${y1 * actualImageScaleY}px`;
                boxDiv.style.width = `${(x2 - x1) * actualImageScaleX}px`;
                boxDiv.style.height = `${(y2 - y1) * actualImageScaleY}px`;

                boxDiv.dataset.title = item.title;
                boxDiv.dataset.location = item.location;

                boxDiv.addEventListener('mouseover', (e) => {
                    if (!alwaysDisplayInfoCheckbox.checked) {
                        infoBox.innerHTML = `<strong>Title:</strong> ${item.title}<br><strong>Location:</strong> ${item.location}`;
                        infoBox.style.display = 'block';
                        // Position info box relative to the mouse cursor
                        const imageContainerRect = imageContainer.getBoundingClientRect();
                        infoBox.style.left = `${e.clientX - imageContainerRect.left + 10}px`;
                        infoBox.style.top = `${e.clientY - imageContainerRect.top + 10}px`;
                    }
                });

                boxDiv.addEventListener('mouseout', () => {
                    if (!alwaysDisplayInfoCheckbox.checked) {
                        infoBox.style.display = 'none';
                    }
                });

                boxDiv.addEventListener('click', () => {
                    if (item.url) {
                        window.open(item.url, '_blank');
                    }
                });

                const boxInfoDiv = document.createElement('div');
                boxInfoDiv.classList.add('box-info');
                if (item.score === 0 && item.min_players === 0 && item.max_players === 0 && item.min_playtime === 0 && item.max_playtime === 0 && item.weight === 0) {
                    boxInfoDiv.innerHTML = `<strong>${item.title}</strong><br>${item.location}<br>‚ö†Ô∏è`;
                } else {
                    boxInfoDiv.innerHTML = `<strong>${item.title}</strong><br>${item.location}<br>‚≠ê ${item.score} üë• ${item.min_players}-${item.max_players} ‚è∞ ${item.min_playtime}-${item.max_playtime} min üß† ${'üß†'.repeat(Math.round(item.weight))}`;
                }
                boxDiv.appendChild(boxInfoDiv);

                imageContainer.appendChild(boxDiv);
            });
        }

        

        function updateDisplayMode() {
            if (alwaysDisplayInfoCheckbox.checked) {
                document.querySelectorAll('.box-info').forEach(el => el.style.display = 'block');
            } else {
                document.querySelectorAll('.box-info').forEach(el => el.style.display = 'none');
            }
        }

        function restoreStateFromLocalStorage() {
            const savedImage = localStorage.getItem('selectedImage');
            if (savedImage) {
                imageSelector.value = savedImage;
                boardgameImage.src = savedImage;
                boardgameImage.onload = () => {
                    displayBoundingBoxes(savedImage);
                    updateDisplayMode(); // Call updateDisplayMode after boxes are displayed
                };
            }

            const savedAlwaysDisplayInfo = localStorage.getItem('alwaysDisplayInfo');
            if (savedAlwaysDisplayInfo !== null) {
                alwaysDisplayInfoCheckbox.checked = (savedAlwaysDisplayInfo === 'true');
            }
            updateDisplayMode(); // Ensure display mode is updated on page load
        }

        window.addEventListener('resize', () => {
            const selectedFilename = imageSelector.value;
            if (selectedFilename) {
                displayBoundingBoxes(selectedFilename);
            }
            updateDisplayMode(); // Add this line
        });
    </script>
</body>
</html>
